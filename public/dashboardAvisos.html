<!DOCTYPE html>
<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="stylesheet" href="styles/dashboard.css">
    <link rel="shortcut icon" href="assets/icon/lagotto-icon.png" type="image/x-icon">
    <title>Dashboard</title>
</head>

<body>
    <div class="sidebar">
        <div class="nav">
            <div class="box_selecionado">
                Dashboards <img src="../assets/icons/notification-bing.png" alt="">
            </div>

            <a href="dashboardPlantios.html" style="color: wheat;">
                <div class="box">
                    Plantios <img src="../assets/icons/field.png" alt="">
                </div>
            </a>

            <a id="config" href="dashboardConfiguracoes.html" style="color: wheat;">
                <div class="box">
                    Configurações <img src="../assets/icons/setting.png" alt="">
                </div>
            </a>
            <a onclick="sair()" href="login_cadastro.html" style="color: wheat;">
                <div class="box">
                    Sair <img src="../assets/icons/logout.png" alt="">
                </div>
            </a>
        </div>
    </div>

    <div class="css_dashboardAviso">
        <div class="css_container">
            <div class="css_titulo">
                <img src="../assets/logo.png" alt="">
                <h2>Dashboard Geral</h2>
            </div>

            <div class="css_dashGerais">
                <div class="css_kpiAlertas">
                    <div class="css_fazendasMonitoradas">
                        <div class="css_etiqueta">
                            <img src="../assets/icons/fazenda.webp" alt="">
                            <h1>Fazendas Monitoradas</h1>
                        </div>
                        <div class="css_contador" id="div_contadorFazendas"></div>
                    </div>


                    <div class="css_alertas">
                        <div class="css_plantiosRisco">
                            <div class="css_etiqueta">
                                <img src="../assets/icons/alertav.png.png" alt="">
                                <h1>Plantios em Risco</h1>
                                <h2 id="kpiQtdPlantiosRisco"></h2>
                                <h3>Regiões com umidade acima de 40% ou abaixo de 30%</h3>
                            </div>
                        </div>
                        <div class="css_plantiosRisco">
                            <div class="css_etiqueta">
                                <img src="../assets/icons/sinoa.png" alt="">
                                <h1>Plantios em Aviso</h1>
                                <h2 id="kpiQtdPlantiosAlerta"></h2>
                                <h3>Regiões com umidade acima de 38% ou abaixo de 32%</h3>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="css_kpiPlantios">
                    <div class="css_kpiEtiqueta">
                        <div class="css_kpiPlantio">
                            <div class="css_etiqueta">
                                <img src="../assets/icons/fungo.webp" alt="">
                                <h1>Plantios Monitorados</h1>
                            </div>
                            <div class="css_contador" id="div_contadorPlantios">
                                <h2 id="kpiQtdPlantiosMonitorados"></h2>
                            </div>
                        </div>
                    </div>
                    <div class="css_graficoPlantio">
                        <div id="graficoPlantio">
                            <canvas id="graficoPizza" width="200" height="200"></canvas>
                            <div id="legendaCustom" style="color: white; margin-left: 80px;"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</body>

</html>
<script>
    let dataPlantios = [];
    carregarPagina();

    async function carregarPagina() {
        await buscarFazendas();

        estatisticasPlantios();
    }

    async function buscarFazendas() {
        let respostaPlantios = await fetch(`/estatisticas/buscarFazendas/${sessionStorage.ID_EMPRESA}`, {
            method: 'GET',
            headers7: {
                'Content-Type': 'application/json'
            }
        });

        if (!respostaPlantios.ok) {
            respostaPlantios.text().then((erro) => {
                console.error(erro);
            });

            return;
        }

        let jsonPlantios = await respostaPlantios.json();

        div_contadorFazendas.innerHTML = `<h2>${jsonPlantios[0].qtdFazendas}`;

        for (const plantio of jsonPlantios) {
            let dataPlantio = [];

            for (let i = 1; i <= plantio.qtdRegioes; i++) {
                let respostaRegiao = await fetch(`/estatisticas/dadosSensorQtdDias/${plantio.idPlantio}/${i}/1`, {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });

                if (!respostaRegiao.ok) {
                    respostaRegiao.text().then((erro) => {
                        console.error(erro);
                    });

                    return;
                }

                let jsonRegiao = await respostaRegiao.json();
                dataPlantio.push(jsonRegiao);
            }

            dataPlantios.push(dataPlantio);
        }

        console.log(dataPlantios);
    }

    async function estatisticasPlantios() {
        let qtdPlantios = dataPlantios.length;
        kpiQtdPlantiosMonitorados.innerHTML = `${qtdPlantios}`;

        let qtdPlantiosRisco = 0;
        let qtdPlantiosAlerta = 0;
        let qtdPlantiosEstaveis = 0;

        for (let i = 0; i < qtdPlantios; i++) {
            let plantio = dataPlantios[i];
            let qtdRegioesCriticas = 0;
            let qtdRegioesAlertas = 0;
            let qtdRegioesEstaveis = 0;

            for (let j = 0; j < plantio.length; j++) {
                let regiao = plantio[j];
                let umidadeAtual = regiao[0].umidade;

                if (umidadeAtual > 40 || umidadeAtual < 30) {
                    qtdRegioesCriticas++;
                } else if (umidadeAtual == 40 || umidadeAtual == 30) {
                    qtdRegioesAlertas++;
                } else {
                    qtdRegioesEstaveis++;
                }
            }

            if(qtdRegioesCriticas > 0) {
                qtdPlantiosRisco++;
            } else if(qtdRegioesAlertas > 0) {
                qtdPlantiosAlerta++;
            } else {
                qtdPlantiosEstaveis++;
            }
        }

        kpiQtdPlantiosRisco.innerHTML = `${qtdPlantiosRisco}`;
        kpiQtdPlantiosAlerta.innerHTML = `${qtdPlantiosAlerta}`;

        const labels = ['Plantios em Risco', 'Plantios em Aviso', 'Plantios Adequados'];
        const descricoes = [
            'Umidade abaixo de 30% ou acima de 40%',
            'Umidade entre 30-32% ou 38-40%',
            'Umidade entre 32% e 38%'
        ];
        const cores = ['#ff4d4d', '#ffd11a', '#4dff88'];

        const legendaDiv = document.getElementById('legendaCustom');
        labels.forEach((label, i) => {
            const item = document.createElement('div');
            item.style.marginBottom = '10px';
            item.innerHTML = `
            <div style="display: flex; align-items: center;">
                <div style="width: 15px; height: 15px; background-color: ${cores[i]}; margin-right: 8px; border-radius: 3px;"></div>
                <strong>${label}</strong>
            </div>
            <div style="margin-left: 23px;">${descricoes[i]}</div>
        `;
            legendaDiv.appendChild(item);
        });

        const ctx = document.getElementById('graficoPizza').getContext('2d');
        const graficoPizza = new Chart(ctx, {
            type: 'pie',
            data: {
                labels: labels,
                datasets: [{
                    label: 'Quantidade',
                    data: [qtdPlantiosRisco, qtdPlantiosAlerta, qtdPlantiosEstaveis],
                    backgroundColor: cores,
                    borderColor: '#ffffff',
                    borderWidth: 2
                }]
            },
            options: {
                plugins: {
                    legend: {
                        display: false
                    },
                    title: {
                        display: false,
                        text: 'Distribuição dos Plantios',
                        color: '#ffffff',
                        padding: 0
                    }
                }
            }
        });

    }

</script>